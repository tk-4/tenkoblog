---
title: CloudflareのWARPを使ってリモートから自宅への環境を整えた話
date: 2023-03-24T23:59:33.000Z
categories:
  - network
  - 自宅ラボ
id: "4207112889972869716"
draft: true
---
ずいぶん前から、Cloudflareのゼロトラストネットワークのサービスが気になっていました。

だって、50アカウントまで無償で利用できるんですよ、奥さん。

小さい会社であれば無料枠で十分。私なんて1アカウントで十分ですね。

これについては色々と「やってみた」関連の記事が多く出てきており、参考情報には恵まれた状態になりました。

そういう背景もあり、私も出先で仕事することが多い身ということもあり、
重い腰を上げてCloudflareを使ったリモートアクセス環境の構築にチャレンジしました。

いくつか苦労した点はあったものの、実際にリモートから自宅環境にアクセスができましたので、
記録として残しておきます。

## 注意点
インターネット上の記事では、同じ「Cloudflare ゼロトラストネットワーク」という単語でも、書かれている内容が結構異なっている印象があります。<BR>
多いのはSASE系の利用方法に関する記事ですかね。

今回、私の記事で書くのは、ポイントを絞って以下の内容です。記事を読み終わると、「書いてあること」ができるようになるはずです。

- 書いてあること
  - CloudflarenoのWARPを使った、コネクターを入れた環境とのリモート接続
  - アカウント管理は外部IdPを利用せず、メールアドレス＋OTP(One Time Password)を利用した接続
- 書いてないこと
  - CloudflareのWebアクセスやDNSフィルタ、TLS復号などSWG系の利用方法
  - EgressPolicyなどIPルーティングに関する話(これはそのうち別記事を書くかも)
  - 企業での利用で想定される外部IdPや複数ユーザやSCIM連携などを用いた運用方法


## 初めに要点
- リモート接続はSplitTunnelの設定で、Excludeの初期設定サブネットから自宅環境を外し、接続を許可するホストのアドレスをApplicationとして定義すると利用可能
- クライアント側はとりあえずWARPクライアントを入れておき、スイッチのOFF/ONのみで接続手段切り替えが可能

## 概要システム構成
だいぶ端折ってますが、大体こんな感じのシステム構成になっています。
[f:id:tatematsu_san:20230319213245p:plain]



[:contents]

## やることの流れ
ここでは「個人アカウントのみ、手動追加」で設定を行う場合の流れを記載します。

例えば「外部IdPでアカウントを管理しており、その特定グループに所属するユーザには自動的に権限を付与する」みたいな
会社としての利用方法を行う場合には、基本的な流れは変わらないものの、これに少し肉付けが必要と思います。

- Cloudflare Dashbordでやること
  - CloudFlare のアカウントを取得する
  - ユーザ認証で利用するシステム構成を決める
    - 必要に応じてIdPにサインアップする
  - 利用ユーザに招待メールを送信する
    - 利用ユーザでレジストする
  - Cloudflare ZeroTrustのポータルを開く
- Cloudfalre ZeroTrustのポータルでやること
  - 


## Cloudflareのポータルサイトの構造
Cloudflareのサイトの構造は、大体こんな感じになっています。<BR>
私も最初迷子になったので、今回の記事の中で見る箇所を赤色背景にしておきました。

- 左側はどちらかというとWebサイトのCDNとかのコントロールがメイン。
  - ただし、ユーザ管理は左側で行う。
- 右側がZeroTrust Network系のメニュー

[f:id:tatematsu_san:20230321223801p:plain]

各種メニューの役割をピックアップしてご紹介。

| 項目 | 役割 | 
| ---    | ----  |
| Access | ---- |
| - Applications | Tunnel先の、自宅ネットワーク側の環境を登録する場所。ホスト単位が楽ちん。|
| - Tunnels | 「どのセグメントを、どのTunnel（コネクタ）の先にするか」<BR>という設定をする場所 |
| Settings | --- |
| - Network | どういうログをとる？とかTLS復号する？とかそういう設定。<BR>今回はメインじゃない。|
| - Authentication | ログイン認証の設定をする場所。<BR>OTPとかIdPを使うとか、そういうののメイン。|
| - WARP Client | デバイスの状態チェックとか、デバイスプロファイルを定義する。<BR>Tunnel用のSplitTunnelの設定もこちら。|
| - Downloads | 各種OS用のWARPクライアントの他、<BR>TLS復号のためのCloudflareの証明書などがダウンロード可能。|


## 参考にしたサイト

### 公式
- [https://developers.cloudflare.com/cloudflare-one/:title]

### 個人ブログ

- [https://zenn.dev/hiroe_orz17/articles/650463001ee087:title]
- [https://qiita.com/dodolia907/items/5300ec5b3a584ac72c39:title]




---
title: 電動ハニカムシェードがAlexaからコントールできるスマートホーム環境に仲間入りしました。
date: 2023-02-27T04:57:16.000Z
categories:
  - 自宅ラボ
  - IoT
id: "4207112889966912324"
draft: false
---
私は、一条工務店で自宅を建てています。

そこでカーテン替わりに利用している[電動ハニカムシェード](https://chanmin-savings.com/archives/3465)というものがあります。

それを、ずっとアレクサ経由で操作したいと思っていました。

以前からNature Remoを用いて赤外線スマートリモコン替わりに使っていたのですが、
電動ハニカムシェード用のリモコンは赤外線ではないため、Nature Remoだけでは実現できませんでした。


- 「アレクサ、おはよう」...これでリビングの電気が付き、ロボット掃除機が待機所へ引っ込み、TVがつく。
- 「アレクサ、朝の準備して」...これでハニカムシェードが開き、リビングの電気が消える。
- 「アレクサ、夜の準備して」...これでハニカムシェードがおり、リビングの電気がつく。


こんなスマートホーム生活をずっと狙っていたのですが、なかなか実現できず。

今回、やっとそれを実現できたので、実現手段などを備忘として残しておきます。

## はじめに要点
要点は以下の3点くらいです。

- やっててよかった、電子工作。
- Node-REDを使うことで、とてもお手軽にIoT環境の制御ができる。
- ラズパイでNode-REDを動かすときはCPUの世代の差に気を付けよう。
  - （Zero系はARM6、2/3はARM7なので、Zero系を使うなら2/3のやり方ではNG)

## 構成情報
参考情報として、現在の自宅内のIoTの概要図を掲載しておきます。
この中で、紫色・緑色の部分を今回構築することができました。

[f:id:tatematsu_san:20230227124431p:plain]

<!-- more -->



[:contents]

## 要件
- Alexaを経由して、電動ハニカムシェードに対し、以下の命令が出せること
  - UP(電動ハニカムシェードを開ける)
  - STOP(電動ハニカムシェードの動作を停止させる)
  - DOWN(電動ハニカムシェードを閉める)
- 機器が故障した場合に備え、通常のリモコンによる運用も可能とすること
- 可能な限り新たなハードウェアを導入せず、安価に環境を構築すること

## 使ったハードウェア
- Raspberry Pi ZeroW
  - OS: Raspbian (Release 11)
  - GPIO用のヘッダ　[■Amazonへのリンク](https://www.amazon.co.jp/exec/obidos/ASIN/B01NBTFR5S/ref=nosim?tag=maftracking84407-22&linkCode=ure&creative=6339&th=1)
- 電動ハニカムシェード用のリモコン（改造用）
  - ※営業さんに相談したら、追加で1個ご手配いただけました。
- ブレッドボード(以前適当に買ったもの)
- ジャンパーワイヤー(以前適当に買ったもの)
- 参考サイトにてご紹介いただいていたFET [■Amazonへのリンク](https://www.amazon.co.jp/SSCI-023979-%E3%82%B9%E3%82%A4%E3%83%83%E3%83%81%E3%82%B5%E3%82%A4%E3%82%A8%E3%83%B3%E3%82%B9-2ch-FET%E4%BB%98%E3%81%8DLED%E3%83%9C%E3%83%BC%E3%83%89/dp/B014KC2MTK)
- 参考サイトにてご紹介いただいていたピンヘッダ  [■Amazonへのリンク](https://www.amazon.co.jp/exec/obidos/ASIN/B01NBTFR5S/ref=nosim?tag=maftracking84407-22&linkCode=ure&creative=6339&th=1)
- プラスチックのポケットティッシュケース（基盤の入れ物として）
- コルクボード（基盤の入れ物の中の敷物として）
- はんだごてセット

## 作ったもの
### 外観
こんな感じのものを作りました。リモコンはまだ原型をとどめてます。最終的にはもう少し化粧します。

[f:id:tatematsu_san:20230227132206p:plain]

リモコンの下にあるのが、↑に書いた、セリアで買ったポケットティッシュケースです。
箱の外に対してはラズパイZeroWの電源をとるための、USB-TypeAのケーブルが伸びているだけです。

その中はこんな感じになっています。
[f:id:tatematsu_san:20230227132341p:plain]

リモコンの裏はこんな感じ。

[f:id:tatematsu_san:20230227132429p:plain]

参考サイトのハードウェア編に書いてあるのと同じような形で、VCC/GND/UP/STOP/DOWNの部分にはんだ付けし、FETを経由してブレッドボードにつないでます。

正直、改めて思うとブレッドボード使うならFETを経由させる必要もなかったのですが、まあ個人で使うものなのでヨシです。

大学卒業以来の久しぶりのはんだ付け、楽しかったです。

こればっかりは、未経験だと取っ掛かりに躊躇したと思いますが、大学で電子工学やっててよかったなと思いました。

### ハードウェア構成
基本的に[参考サイトのまま](https://nyoroichijo.hatenablog.com/entry/2021/01/18/%E3%82%A2%E3%83%AC%E3%82%AF%E3%82%B5%E3%80%81%E3%83%8F%E3%83%8B%E3%82%AB%E3%83%A0%E3%82%B7%E3%82%A7%E3%83%BC%E3%83%89%E3%82%92%E9%96%8B%E3%81%91%E3%81%A6%28%E3%83%8F%E3%83%BC%E3%83%89%E3%82%A6)なので、ここでは割愛します。細かく知りたい方がいれば、ブログやTwitterでコメントいただければ追記します。

一応、▲■▼の3種類の信号を外に出しました。電動ハニカムシェードが1台しかないこともあり、SELECTは不要と判断しました。

そういう理由もあり、FETは2つ使っています。

### ソフトウェア構成
こちらも、[各種参考サイト](https://tenko.hatenablog.jp/preview#%E5%8F%82%E8%80%83%E3%81%AB%E3%81%97%E3%81%9F%E3%82%B5%E3%82%A4%E3%83%88)をもとにラズパイZeroWにNode-REDをセットアップし、Node-RED HomeSkillBridgeにアカウントを作ったりして設定しています。

上記の解説は長くなるので、基本は参考サイトをご覧ください。

#### ハマった点
最初、参考サイトと同様に、ラズパイ3でNode-RED環境を作ってました。

その後、ラズパイZeroWでいいな？と思い始めてそちらにSDカードを移植したのですが、そのままだとNode-REDが動かず。

やっちまったかと思っていろいろとみていったら、以下の情報を得られました。

- ラズパイZero/ZeroWとラズパイ2/3はCPUのARMのバージョンが異なる。
  - Zero系はARMv6 、2/3はARMv7
- 上記に合わせてNode.jsも専用のバージョンがある

そのため、移植したものをそのまま活用するのをあきらめ、ZeroW側でNode-REDを再インストールしています。

### GPIOとNode-RED内の構成
ここまでは基本的に参考サイトを参照していただくとして、ここを細かく書いておこうかなと思います。

リモコンからの信号をブレッドボードを経由して、ラズパイのGPIOに対して以下のように接続しました。

- UP(ハニカムシェードを上げる)...GPIO17
- STOP(ハニカムシェードの上下動作を止める)...GPIO27
- DOWN(ハニカムシェードを下げる)..GPIO22

最終的に作成した、Node-REDのフローがこちらです。

[f:id:tatematsu_san:20230227133758p:plain]


#### Node-RED Home Skill Bridge上のデバイス登録の注意点

Node-REDのHome Skill Bridge上に登録した、ラズパイZeroWの設定はこんな形です。(スペルミスってる気がしますが気にしない)
[f:id:tatematsu_san:20230227133859p:plain]

最初は参考サイト通りにON/OFFのみにしていたのですが、STOPを組み込みたいと思いました。

そうするとTrue/Falseだけでは分岐が足りません。

そのため、調光式LED（LIGHT）のアプリケーションとして、その明るさの％をチェックを入れることでそれを3分岐の制御につなげようと考えて、このようなデバイス登録にしました。

On/Offは現在だと消しても問題ないかなと思ってます。

#### フローの説明
一番上のフローは、Node-REDを起動した際に上記3つのGPIOの出力をLowにするためのものです。
初期化というやつです。

2番目のフローが本命です。

一条工務店のリモコンは、最初になにかボタンを押した状態では「信号待機状態」になるのみで、そのあとにもう一度操作のボタンを押すことで、はじめて操作信号が飛びます。

そのため、以下のようなフローにしました。

- Alexa ホームスキルから呼び出しが来る。
- ひとまず、STOPボタンのGPIOをONして、信号待機状態にさせる。
  - この間、メイン側はDelayで待機状態にさせる。
- Delayが明けたら、ホームスキルから渡されたメッセージの中身に応じて分岐する。
  - アレクサのホームスキルから渡された温度が入ってくるのが、` message.payload` で、そこに数字が直接入ってくる。
  - そのため、入ってきた数字を以下の条件で分岐する。
    - 100をUP
    - 60をSTOP
    - 10をDOWN
  - 分岐の後は、各GPIOの信号をONし、リモコン側のボタンを押したことにする。
  - 電動ハニカムシェード側がリモコンからの信号をうけ、指示された通りに動く
  - 一定時間後、GPIOの各信号をOFFにする。

分岐の詳細はこんな感じです。

[f:id:tatematsu_san:20230227135347p:plain]

最初はこのあたりをどうチューニングすればいいのかよくわかりませんでしたが、触っているうちにだんだんと理解できました。

Node-RED、学習教材みたいなタッチで簡単にラズパイのGPIOがコントロールできるので、非常に手軽でよいですね。

## 結局、やりたいことはできたのか？

- 「アレクサ、おはよう」...これでリビングの電気が付き、ロボット掃除機が待機所へ引っ込み、TVがつく。
- 「アレクサ、朝の準備して」...これでハニカムシェードが開き、リビングの電気が消える。
- 「アレクサ、夜の準備して」...これでハニカムシェードがおり、リビングの電気がつく。

これ、全部できるようになりました。

1個目まではこれまでもできてたのですが、２・３個目が実現できてなかったのです。

これで朝と夜がかなり楽になったと思います。めちゃ便利。

## 今後の展開
Node-REDを活用することで、GPIOまわりのコントロールやAlexaとの連携が非常に楽にできることが分かりました。

今後はGPIO関係ない形で何かのチェック結果をAlexaにしゃべらせたり、他の形でGPIO制御したりなど、いろいろと応用ができそうですので、それを模索していきたいと思います。

どなたかの参考になれば幸いです。

## 一条工務店で家を建てる人へ
この記事の中身からこれを見る人も少ないと思いますが、ハニカムシェードを全面採用するなら、是非大きい窓につけるハニカムシェードはすべて初期段階で電動にしましょう。

初期コストも大したことありませんし、運用にかかるコストが段違いです。

自動化できる・できないにかかわらず、操作用の紐の操作で感じる重量は重く、割と毎日の紐での上げ下げは負担になります。

また、重量の関係で、後付けでの巻き上げ式IoT化は今のところ挫折しています。またこれはチャレンジしたい。

是非、初期から電動化をお勧めします。

## 参考にしたサイト
### そもそものアイディア
こちらの2つのブログ記事がなければ、やってみようと思わなかったと思います。

著者の方、本当にありがとうございました。

[https://nyoroichijo.hatenablog.com/entry/2021/03/22/%E3%82%A2%E3%83%AC%E3%82%AF%E3%82%B5%E3%80%81%E3%83%8F%E3%83%8B%E3%82%AB%E3%83%A0%E3%82%B7%E3%82%A7%E3%83%BC%E3%83%89%E3%82%92%E9%96%8B%E3%81%91%E3%81%A6%28%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6:title]


[https://nyoroichijo.hatenablog.com/entry/2021/01/18/%E3%82%A2%E3%83%AC%E3%82%AF%E3%82%B5%E3%80%81%E3%83%8F%E3%83%8B%E3%82%AB%E3%83%A0%E3%82%B7%E3%82%A7%E3%83%BC%E3%83%89%E3%82%92%E9%96%8B%E3%81%91%E3%81%A6%28%E3%83%8F%E3%83%BC%E3%83%89%E3%82%A6:title]



### ラズパイ3でNode-REDが動いたのにSDをラズパイZeroWに移植したら動かなかったときに見たサイト
[こちらのコミュニティの書き込み](https://forums.raspberrypi.com/viewtopic.php?t=205640)を参考することで、CPUの種類が違うとNode.jsもそのままでは動かない、ということを知りました。

### ラズパイZeroWへのNode-REDのインストール
[こちらのサイト](https://chigusa-web.com/blog/%E3%83%A9%E3%82%BA%E3%83%91%E3%82%A4%E3%81%ABnode-red%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB/)を参考にさせていただきました。

### GPIOまわりのデバッグ
[こちらのサイト](https://tool-lab.com/raspberrypi-startup-24/)を参考にさせていただきました。

### Node-REDの日本ユーザグループサイト
メッセージに関するカスタマイズに、[こちらの記事](https://nodered.jp/docs/user-guide/messages)を参考にさせていただきました。

### Node-REDの使い方
[こちらのサイト](https://smartlight.co.jp/2021/08/05/trigger-a-flow-whenever-node-red-starts/)を参考にさせていただきました。動画もあり、とても分かりやすかったです。


